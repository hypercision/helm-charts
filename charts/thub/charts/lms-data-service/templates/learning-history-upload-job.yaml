{{- if .Values.learningHistoryUploadJob.enabled -}}
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: lms-learning-history-upload-job
  # These labels do not also get added to the pods created by this job
  labels:
    {{- include "lms-data-service.labels" . | nindent 4 }}
    jobCommonName: lms-learning-history-upload-job
  annotations:
    description: >
      Sends a message to the LMS Data Service application via ActiveMQ notifying it to
      download learning history files from AWS S3 and upload them to the LMS.
spec:
  schedule: {{ .Values.learningHistoryUploadJob.schedule | quote }}
  concurrencyPolicy: {{ .Values.learningHistoryUploadJob.concurrencyPolicy | quote }}
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: thub-event-scheduler-job
            image: "{{ .Values.learningHistoryUploadJob.image.repository }}:{{ .Values.learningHistoryUploadJob.image.tag | default (include "thub.eventSchedulerJobTag" .) }}"
            imagePullPolicy: {{ .Values.learningHistoryUploadJob.image.pullPolicy }}
            ports:
            - containerPort: {{ .Values.learningHistoryUploadJob.port }}
              name: http-server
            resources:
              {{- toYaml .Values.global.eventSchedulerResources | nindent 14 }}
            env:
            - name: server.port
              value: {{ .Values.learningHistoryUploadJob.port | quote }}
            - name: hclabs.scheduler.destinationQueue
              value: {{ include "thub.sfLmsDataJobQueueName" . }}
            - name: hclabs.scheduler.messageFile
              value: "./temp/start-lms-learning-history-job.json"
            envFrom:
            - configMapRef:
                name: {{ .Values.global.activemqBrokerConfigMapName }}
            volumeMounts:
            - name: message-file
              mountPath: /app/temp
              readOnly: true
          volumes:
            - name: message-file
              configMap:
                # Provide the name of the ConfigMap containing the files you want
                # to add to the container
                name: {{ include "lms-data-service.eventSchedulerInputFilesConfigmapName" . }}
          restartPolicy: {{ .Values.learningHistoryUploadJob.restartPolicy }}
{{- end }}
